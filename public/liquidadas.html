<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fruta liquidada - Portal Proveedores</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root { --bg:#f7f7f8; --card:#fff; --ink:#222; --muted:#666; --brand:#0a7cff; --shadow:0 8px 24px rgba(0,0,0,.08); }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--ink); }
    .wrap { max-width:1100px; margin:24px auto; padding: 0 16px; }
    .card { background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:16px; }
    h1 { font-size:22px; margin:0 0 8px; }
    .muted { color:var(--muted); font-size:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    button { padding:10px 12px; font-size:15px; border:0; border-radius:10px; background:var(--brand); color:#fff; cursor:pointer; }
    button.secondary { background:#e5e7eb; color:#111; }
    button.ghost { background:transparent; color:var(--brand); border:1px solid var(--brand); }
    .grid-btns { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 4px; }
    .btn-big { font-size:16px; padding:12px 16px; border-radius:12px; }
    table { width:100%; border-collapse: collapse; margin-top:8px; background:#fff; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:14px; white-space:nowrap; }
    th { background:#fafafa; position:sticky; top:0; z-index:1; }
    .badge { display:inline-block; padding:2px 8px; font-size:12px; border-radius:999px; background:#eef2ff; color:#3730a3; }
    .totals { margin-top:6px; font-weight:600; }
    .pill { display:inline-block; background:#f1f5f9; color:#0f172a; padding:4px 8px; border-radius:999px; font-size:12px; }
    .spacer { height:8px; }
    .right { text-align:right; }
    #filtroDetalle { display:none; align-items:center; gap:8px; margin:4px 0 0 0; }
    #selEspecie { padding:6px 10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <h1>Fruta liquidada</h1>
          <div class="muted">Proveedor: <span id="provNombre" class="pill"></span></div>
          <div class="muted">√öltima actualizaci√≥n: <span id="stamp"></span></div>
        </div>
        <div class="row">
          <button class="ghost" onclick="location.href='index.html'">Volver</button>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="grid-btns">
        <button class="btn-big" id="btnAgrupado">üìä Agrupado</button>
        <button class="btn-big secondary" id="btnDetalle">üìã Detalle</button>
        <button class="btn-big secondary" id="btnExcel">‚¨áÔ∏è Descargar Excel</button>
      </div>

      <!-- Filtro SOLO para Detalle -->
      <div id="filtroDetalle" class="row">
        <label for="selEspecie">Especie:</label>
        <select id="selEspecie">
          <option value="TODAS">Todas</option>
          <option value="pera">Pera</option>
          <option value="manza">Manzana</option>
        </select>
      </div>

      <div id="resumen" class="totals"></div>
      <div id="tablaWrap"></div>
    </div>
  </div>

  <script>
    const PATH_LIQ = 'data/profruLiq.json';
    const PATH_STAMP_LIQ = 'data/lastUpdateLiq.json';
    const $ = s => document.querySelector(s);

    // === utilidades de fecha/numero ===
    const excelSerialToStr = (v) => {
      if (typeof v === 'number' && !isNaN(v)) {
        const epoch = new Date(Date.UTC(1899, 11, 30));
        const ms = v * 86400000;
        const d = new Date(epoch.getTime() + ms);
        return toDDMMYYYY(d);
      }
      const d = new Date(v);
      if (!isNaN(d.getTime())) return toDDMMYYYY(d);
      return v || '';
    };
    const toDDMMYYYY = (d) => {
      const dd = String(d.getUTCDate()).padStart(2,'0');
      const mm = String(d.getUTCMonth()+1).padStart(2,'0');
      const yyyy = d.getUTCFullYear();
      return `${dd}/${mm}/${yyyy}`;
    };
    // kilos con 2 decimales solo si realmente los hay (evita falsos decimales por flotante)
    const fmtKg = (n) => {
      const x = Number(n) || 0;
      const eps = 0.005; // ~5 gramos al redondear a 2 decimales
      const diffFromNearestInt = Math.abs(x - Math.round(x));
      const hasDecimals = diffFromNearestInt >= eps;
      const opts = hasDecimals
        ? { minimumFractionDigits: 2, maximumFractionDigits: 2 }
        : { maximumFractionDigits: 0 };
      return x.toLocaleString('es-AR', opts);
    };
    const toMillis = (v) => {
      if (typeof v==='number' && !isNaN(v)) return new Date(Date.UTC(1899,11,30)).getTime()+v*86400000;
      const d=new Date(v); return d.getTime();
    };
    const especieKey = (v)=>{ v=String(v||'').toLowerCase(); return v.includes('manza')?'manza': v.includes('pera')?'pera':'otros'; };

    // Estado global
    let __datosProv = [];
    let __mode = 'agrupado';

    function getProv(){
      const qs = new URLSearchParams(location.search);
      const p = qs.get('prov');
      if (p && p.trim()) return decodeURIComponent(p).trim();
      try { const ls = localStorage.getItem('provNombre'); if (ls && ls.trim()) return ls.trim(); } catch(_){}
      return '';
    }
    function normalizarProveedor(v){ return String(v||'').trim(); }

    async function fetchJSON(url){
      const r = await fetch(url, { cache:'no-store' });
      if(!r.ok) throw new Error('No se pudo leer '+url);
      return r.json();
    }

    // === AGRUPADO: primero por NroLiq (sin cortar por especie) ===
    function agruparPorNroLiq(rows){
      const m = new Map();
      for(const r of rows){
        const nro = String(r.NroLiq ?? '-');
        if(!m.has(nro)) m.set(nro, { NroLiq:nro, kgs:0, cant:0, fechas:[] });
        const o = m.get(nro);
        o.cant += 1;
        o.kgs += Number(r.KgsD)||0;
        if(r.FechaLiq!==undefined && r.FechaLiq!==null && r.FechaLiq!=='') o.fechas.push(r.FechaLiq);
      }
      const arr = Array.from(m.values()).map(o=>({
        NroLiq:o.NroLiq,
        FechaLiq: pickMaxFecha(o.fechas),
        cant:o.cant,
        kgs:o.kgs
      }));
      arr.sort((a,b)=> (toMillis(b.FechaLiq)-toMillis(a.FechaLiq)) || String(a.NroLiq).localeCompare(String(b.NroLiq), undefined, { numeric:true }));
      return arr;
    }
    function pickMaxFecha(arr){ if(!arr.length) return ''; let best=-Infinity; for(const v of arr){ const ms=toMillis(v); if(ms>best) best=ms; } return toDDMMYYYY(new Date(best)); }

    function renderAgrupado(datosProv){
      const tot = datosProv.reduce((a,b)=>a+(Number(b.KgsD)||0),0);
      $('#resumen').textContent = `${datosProv.length} registros ¬∑ ${fmtKg(tot)} kg`;
      const arr = agruparPorNroLiq(datosProv);

      let html = `<table><thead><tr>`+
        `<th>NroLiq</th><th>FechaLiq</th><th class='right'>Cant reg.</th><th class='right'>Kgs totales</th>`+
        `</tr></thead><tbody>`;
      for(const it of arr){
        html += `<tr>`+
          `<td><span class='badge'>${it.NroLiq}</span></td>`+
          `<td>${it.FechaLiq}</td>`+
          `<td class='right'>${it.cant}</td>`+
          `<td class='right'>${fmtKg(it.kgs)}</td>`+
        `</tr>`;
      }
      html += `</tbody></table>`;
      $('#tablaWrap').innerHTML = html;
      setMode('agrupado');
    }

    // === DETALLE (con filtro de especie) ===
    function renderDetallado(datosProv){
      const sel = $('#selEspecie');
      const wanted = sel ? sel.value : 'TODAS';
      let rows = datosProv;
      if (wanted !== 'TODAS') rows = rows.filter(r => especieKey(r.Especie) === wanted);

      rows = [...rows].sort((a,b)=> toMillis(b.Fecha) - toMillis(a.Fecha));
      const tot = rows.reduce((a,b)=>a+(Number(b.KgsD)||0),0);
      $('#resumen').textContent = `${rows.length} registros ¬∑ ${fmtKg(tot)} kg`;

      if (!rows.length){
        $('#tablaWrap').innerHTML = `<p style="margin:8px 0;color:#666;">No hay registros para la especie seleccionada.</p>`;
        setMode('detalle');
        return;
      }

      let html = `<table><thead><tr>`+
        `<th>NroLiq</th><th>FechaLiq</th>`+
        `<th>Nro Jugos</th><th>Fecha Ingr.</th><th>Remito</th>`+
        `<th>NomVariedad</th><th class='right'>KgsD</th>`+
        `</tr></thead><tbody>`;
      for(const r of rows){
        html += `<tr>`+
          `<td><span class='badge'>${r.NroLiq||'-'}</span></td>`+
          `<td>${excelSerialToStr(r.FechaLiq)}</td>`+
          `<td>${r['Nro Jugos']||''}</td>`+
          `<td>${excelSerialToStr(r.Fecha)}</td>`+
          `<td>${r.Remito||''}</td>`+
          `<td>${r.NomVariedad||''}</td>`+
          `<td class='right'>${fmtKg(r.KgsD)}</td>`+
        `</tr>`;
      }
      html += `</tbody></table>`;
      $('#tablaWrap').innerHTML = html;
      setMode('detalle');
    }

    function setMode(m){
      __mode = m;
      const bAgr = $('#btnAgrupado'), bDet = $('#btnDetalle');
      const fd = $('#filtroDetalle');
      if(m==='detalle'){
        bAgr.classList.add('secondary'); bDet.classList.remove('secondary');
        if (fd) fd.style.display = 'flex';
      } else {
        bDet.classList.add('secondary'); bAgr.classList.remove('secondary');
        if (fd) fd.style.display = 'none';
      }
    }

    // === Exportar a Excel
    function descargarExcel(){
      if (!window.XLSX){ alert('No se pudo cargar el generador de Excel.'); return; }
      const prov = $('#provNombre').textContent || 'proveedor';
      if (__mode === 'detalle'){
        const sel = $('#selEspecie');
        const wanted = sel ? sel.value : 'TODAS';
        let rows = __datosProv;
        if (wanted !== 'TODAS') rows = rows.filter(r => especieKey(r.Especie) === wanted);
        rows = [...rows].sort((a,b)=> toMillis(b.Fecha) - toMillis(a.Fecha));
        const out = rows.map(r => ({
          NroLiq: r.NroLiq||'',
          FechaLiq: excelSerialToStr(r.FechaLiq),
          'Nro Jugos': r['Nro Jugos']||'',
          'Fecha Ingr.': excelSerialToStr(r.Fecha),
          Remito: r.Remito||'',
          NomVariedad: r.NomVariedad||'',
          KgsD: Number(r.KgsD)||0
        }));
        const ws = XLSX.utils.json_to_sheet(out);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Detalle');
        XLSX.writeFile(wb, `liquidadas_detalle_${prov}.xlsx`);
      } else {
        const arr = agruparPorNroLiq(__datosProv);
        const out = arr.map(it => ({ NroLiq: it.NroLiq, FechaLiq: it.FechaLiq, 'Cant reg.': it.cant, 'Kgs totales': Number(it.kgs)||0 }));
        const ws = XLSX.utils.json_to_sheet(out);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Agrupado');
        XLSX.writeFile(wb, `liquidadas_agrupado_${prov}.xlsx`);
      }
    }

    // === init ===
    async function init(){
      const prov = getProv();
      if(!prov){ location.href = 'index.html'; return; }
      $('#provNombre').textContent = prov;

      try{
        const [rows, stamp] = await Promise.all([
          fetchJSON(PATH_LIQ),
          fetchJSON(PATH_STAMP_LIQ).catch(()=>({ fecha:'' }))
        ]);
        __datosProv = rows.filter(r => normalizarProveedor(r.ProveedorT) === prov.trim());
        $('#stamp').textContent = stamp.fecha || '';

        if (!__datosProv.length){
          $('#resumen').textContent = `0 registros ¬∑ 0 kg`;
          $('#tablaWrap').innerHTML = `<p style=\"margin:8px 0;color:#666;\">No hay liquidaciones para este proveedor.</p>`;
          setMode('agrupado');
        } else {
          renderAgrupado(__datosProv);
        }

        $('#btnAgrupado').onclick = ()=> renderAgrupado(__datosProv);
        $('#btnDetalle').onclick  = ()=> renderDetallado(__datosProv);
        $('#btnExcel').onclick    = descargarExcel;
        const sel = $('#selEspecie');
        if (sel) sel.onchange = ()=> { if(__mode==='detalle') renderDetallado(__datosProv); };
      }catch(e){
        alert('No se pudieron cargar las liquidaciones.');
      }
    }
    init();
  </script>
</body>
</html>
