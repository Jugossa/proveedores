<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Portal Proveedores - Celular</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 10px; }
    button {
      display: block;
      width: 90%;
      max-width: 320px;
      margin: 10px auto;
      padding: 20px;
      font-size: 20px;
      border-radius: 10px;
    }
    .btn-verde { background-color: #008f00; color: white; }
    .btn-azul { background-color: #007bff; color: white; }
    table {
      margin: 10px auto;
      border-collapse: collapse;
      width: 95%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 14px;
    }
    #detalleEspecie { display: none; }
  </style>
</head>
<body>
  <h2>Ingreso de Proveedores</h2>
  <div id="login">
    <input id="cui" placeholder="CUIT / CUIL"><br>
    <input id="clave" type="password" placeholder="ContraseÃ±a"><br>
    <button onclick="login()">Ingresar</button>
  </div>
  <div id="bienvenida" style="display:none;"></div>
  <div id="pantalla2" style="display:none;">
    <h3>Entregas</h3>
    <button id="btnPera" class="btn-azul" onclick="verDetalle('PERA')"></button>
    <button id="btnManza" class="btn-azul" onclick="verDetalle('MANZA')"></button>
    <button id="btnTodas" class="btn-azul" onclick="verDetalle('TODAS')"></button>
    <button class="btn-verde" onclick="verDetalle('DETALLE')">Ver detalles</button>
  </div>
  <div id="detalleEspecie">
    <div id="tablaMini"></div>
    <button onclick="volver()">Volver</button>
  </div>
  <script>
    let entregas = [], proveedor = "", actualizacion = "";

    async function login() {
      const cui = document.getElementById("cui").value.trim();
      const clave = document.getElementById("clave").value.trim();
      const res = await fetch("/login", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cui, password: clave })
      });
      if (!res.ok) return alert("CUIT o clave incorrectos");
      const data = await res.json();
      entregas = data.entregas || [];
      proveedor = data.proveedor;
      actualizacion = data.ultimaActualizacion;
      mostrarResumen();
    }

    function mostrarResumen() {
      document.getElementById("login").style.display = "none";
      document.getElementById("bienvenida").style.display = "block";
      document.getElementById("pantalla2").style.display = "block";
      document.getElementById("bienvenida").innerHTML =
        `âœ… <b>Bienvenido ${proveedor}</b><br><small>Ãšltima actualizaciÃ³n: ${actualizacion}</small>`;

      const total = entregas.reduce((a, e) => a + Number(e.KgsD || 0), 0);
      const totalPera = entregas.filter(e => (e.Especie || '').toLowerCase() === 'pera')
                                 .reduce((a, e) => a + Number(e.KgsD || 0), 0);
      const totalManza = entregas.filter(e => (e.Especie || '').toLowerCase() === 'manza')
                                 .reduce((a, e) => a + Number(e.KgsD || 0), 0);

      document.getElementById("btnPera").textContent = `ðŸ Pera - ${totalPera.toLocaleString('es-AR')} kg`;
      document.getElementById("btnManza").textContent = `ðŸŽ Manzana - ${totalManza.toLocaleString('es-AR')} kg`;
      document.getElementById("btnTodas").textContent = `ðŸ“‹ Todas - ${total.toLocaleString('es-AR')} kg`;
    }

    function verDetalle(tipo) {
      document.getElementById("pantalla2").style.display = "none";
      document.getElementById("detalleEspecie").style.display = "block";

      let datos = entregas;
      if (tipo === "PERA") datos = entregas.filter(e => (e.Especie || '').toLowerCase() === 'pera');
      else if (tipo === "MANZA") datos = entregas.filter(e => (e.Especie || '').toLowerCase() === 'manza');
      else if (tipo === "DETALLE") datos = entregas;

      let html = "<table><tr><th>Nro Jugos</th><th>Fecha</th><th>Kgs</th></tr>";
      datos.forEach(e => {
        const fecha = new Date(1899, 11, 30 + Number(e.Fecha || 0));
        html += `<tr><td>${e["Nro Jugos"]}</td><td>${fecha.toLocaleDateString("es-AR")}</td><td>${Number(e.KgsD || 0).toLocaleString("es-AR")}</td></tr>`;
      });
      html += "</table>";
      document.getElementById("tablaMini").innerHTML = html;
    }

    function volver() {
      document.getElementById("pantalla2").style.display = "block";
      document.getElementById("detalleEspecie").style.display = "none";
    }
  </script>
</body>
</html>
