<!DOCTYPE html>
<html lang="es">
 <head>
  <meta charset="utf-8"/>
  <title>Portal Proveedores</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">
    function mostrarResumenTotales(data) {
      const totalPera = data.filter(e => (e.Especie || "").toLowerCase() === "pera").reduce((sum, e) => sum + Number(e.KgsD || 0), 0);
      const totalManza = data.filter(e => (e.Especie || "").toLowerCase() === "manza").reduce((sum, e) => sum + Number(e.KgsD || 0), 0);
      const total = data.reduce((sum, e) => sum + Number(e.KgsD || 0), 0);
      document.getElementById("btnPera").innerText = `üçê Pera - ${totalPera.toLocaleString("es-AR")} kg`;
      document.getElementById("btnManzana").innerText = `üçé Manzana - ${totalManza.toLocaleString("es-AR")} kg`;
      document.getElementById("btnTodas").innerText = `üìã Todas - ${total.toLocaleString("es-AR")} kg`;
    }

    function mostrarMiniDetalle(tipo) {
      const cont = document.getElementById("miniDetalle");
      let datos = entregasOriginal;
      if (tipo === "pera") {
        datos = datos.filter(e => (e.Especie || "").toLowerCase() === "pera");
      } else if (tipo === "manza") {
        datos = datos.filter(e => (e.Especie || "").toLowerCase() === "manza");
      }

      const mini = datos.map(e => {
        const nro = e.nro || "-";
        const fec = convertirFecha(e.Fecha);
        const kgs = Number(e.KgsD || 0).toLocaleString("es-AR");
        return `<tr><td>${nro}</td><td>${fec}</td><td style="text-align:right;">${kgs}</td></tr>`;
      });

      cont.innerHTML = `
        <table style="margin:10px auto; font-size: 14px;">
          <thead><tr><th>Nro</th><th>Fecha</th><th>Kgs</th></tr></thead>
          <tbody>${mini.join("")}</tbody>
        </table>
        <button onclick="volverResumen()" style="margin-top: 5px; padding: 10px 15px;">üîô Volver</button>
      `;
      cont.style.display = "block";
      document.getElementById("resumenEspecies").style.display = "none";
    }

    function volverResumen() {
      document.getElementById("miniDetalle").style.display = "none";
      document.getElementById("resumenEspecies").style.display = "block";
    }

</script>
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 16px;
      margin: 0;
      padding: 10px;
      background-color: #f9f9f9;
      text-align: center;
    }
    input, button {
      width: 90%;
      font-size: 1.2em;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }
    #login {
      display:flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 70vh;
    }
    button { cursor: pointer; }
    #resumenEspecies h2 { margin-bottom: 10px; }
    #resumenTotales { font-size: 18px; font-weight: bold; margin: 10px 0; }
    #filtros, #tabla, #acciones { margin: 15px auto; text-align: left; max-width: 95%; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; white-space: nowrap; }
    th { background: #eee; }
  </style>
 </head>
 <body>
  <div id="titulo" style="text-align: center; margin-bottom: 10px;">
   <img alt="Logo Jugos SA" src="img/logo.png" style="height: 60px;"/>
   <h2 style="margin: 10px 0;">Ingreso de Proveedores</h2>
  </div>
  <div id="login">
   <input id="cui" placeholder="CUIT / CUIL" type="text"/>
   <input id="password" placeholder="Contrase√±a" type="password"/>
   <button onclick="login()">Ingresar</button>
  </div>
  <div id="avisoCuit" style="font-size: 12px; color: #444;">
   * El CUIT puede ingresarse con o sin guiones.
  </div>
  <div id="error" style="color: red; margin-top: 10px;"></div>
  <div id="bienvenida" style="display:none; font-weight: bold; margin-top: 15px;"></div>
  <div id="aviso" style="font-size: 12px; display: none;">Cualquier consulta comunicarse con la administraci√≥n de Jugos SA.</div>

  <div id="miniDetalle" style="display:none; margin-top:10px;"></div>
  <div id="resumenEspecies" style="display:none; text-align:center; margin-top: 20px;">
    <h2>Entregas</h2>
    <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin: 10px 0;">
      <button style="background-color:#007bff; height:60px; font-size:1.1em; width:140px; color:white; border:none;">üçê Pera</button>
      <button style="background-color:#007bff; height:60px; font-size:1.1em; width:140px; color:white; border:none;">üçé Manzana</button>
      <button style="background-color:#007bff; height:60px; font-size:1.1em; width:140px; color:white; border:none;">üìã Todas</button>
    </div>
    
    <button onclick="mostrarDetalle()" style="padding: 15px 20px; background-color: green; color: white; border: none; border-radius: 5px; font-size: 1.1em; width: 140px; margin-top: 15px;">
      Ver detalles
    </button>
  </div>

  <div id="filtros" style="display:none;">
    <label for="filtroEspecie">Especie:</label>
    <select id="filtroEspecie"><option value="TODAS">Todas</option></select>
    <label for="desde">Desde:</label>
    <input id="desde" type="date"/>
    <label for="hasta">Hasta:</label>
    <input id="hasta" type="date"/>
    <button onclick="filtrarEspecie()">Ver</button>
  </div>

  <div id="acciones" style="display:none;">
    <button onclick="descargarExcel()">üìÑ Descargar Excel</button>
    <button onclick="window.print()">üìÖ Descargar PDF</button>
  </div>

  <div id="tabla"></div>

  <script>
    let entregasOriginal = [];
    let entregasFiltradas = [];

    function convertirFecha(excelNumber) {
      const baseDate = new Date(1899, 11, 30);
      const dias = parseInt(excelNumber);
      if (isNaN(dias)) return excelNumber;
      const fecha = new Date(baseDate.getTime() + dias * 86400000);
      return fecha.toLocaleDateString("es-AR");
    }

    async function login() {
      const cui = document.getElementById("cui").value.trim();
      const password = document.getElementById("password").value.trim();
      const errorDiv = document.getElementById("error");
      errorDiv.textContent = "";

      if (!cui || !password) {
        errorDiv.textContent = "Por favor complete CUIT y contrase√±a.";
        return;
      }

      try {
        const res = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cui, password })
        });

        if (res.status === 401) {
          errorDiv.textContent = "‚ùå CUIT o contrase√±a incorrectos.";
          return;
        }

        const result = await res.json();
        entregasOriginal = result.entregas.map(e => ({ ...e, Especie: (e.Especie || '').toUpperCase(), FechaStr: convertirFecha(e.Fecha) }));
        document.getElementById("login").style.display = "none";
        document.getElementById("avisoCuit").style.display = "none";
        document.getElementById("bienvenida").style.display = "block";
        document.getElementById("bienvenida").innerHTML = `‚úÖ Bienvenido <strong>${result.proveedor}</strong><br><span style="font-size: 13px; color: gray;">√öltima actualizaci√≥n: ${result.ultimaActualizacion}</span>`;
        document.getElementById("aviso").style.display = "block";
        mostrarResumenTotales(entregasOriginal);
        document.getElementById("resumenEspecies").style.display = "block";
      } catch (err) {
        errorDiv.textContent = "‚ùå Error de red.";
      }
    }

    function mostrarResumenTotales(data) {
      const totalPera = data.filter(e => e.Especie.toLowerCase() === "pera").reduce((sum, e) => sum + Number(e.KgsD || 0), 0);
      const totalManza = data.filter(e => e.Especie.toLowerCase() === "manza").reduce((sum, e) => sum + Number(e.KgsD || 0), 0);
      const total = data.reduce((sum, e) => sum + Number(e.KgsD || 0), 0);
      const resumenDiv = document.getElementById("resumenTotales");
      resumenDiv.innerHTML = `üçê ${totalPera.toLocaleString("es-AR")} kg | üçé ${totalManza.toLocaleString("es-AR")} kg | Total: <strong>${total.toLocaleString("es-AR")} kg</strong>`;
    }

    function mostrarDetalle() {
      document.getElementById("resumenEspecies").style.display = "none";
      document.getElementById("filtros").style.display = "block";
      document.getElementById("acciones").style.display = "block";
      filtrarEspecie();
    }

    function fechaDentroDeRango(fechaStr, desdeStr, hastaStr) {
      if (!desdeStr && !hastaStr) return true;
      const [dia, mes, anio] = fechaStr.split("/");
      const fecha = new Date(`${anio}-${mes}-${dia}`);
      const desde = desdeStr ? new Date(desdeStr) : null;
      const hasta = hastaStr ? new Date(hastaStr) : null;
      if (desde && fecha < desde) return false;
      if (hasta && fecha > hasta) return false;
      return true;
    }

    function filtrarEspecie() {
      const especie = document.getElementById("filtroEspecie").value;
      const desde = document.getElementById("desde").value;
      const hasta = document.getElementById("hasta").value;

      entregasFiltradas = entregasOriginal.filter(e => {
        const coincideEspecie = especie === "TODAS" || e.Especie === especie;
        const enRango = fechaDentroDeRango(e.FechaStr, desde, hasta);
        return coincideEspecie && enRango;
      });

      renderTabla(entregasFiltradas);
    }

    function renderTabla(data) {
      const tablaDiv = document.getElementById("tabla");
      if (!data.length) {
        tablaDiv.innerHTML = "<p>No hay datos.</p>";
        return;
      }

      const columnasOcultas = ["pagado", "ProveedorT"];
      const encabezados = Object.keys(data[0]).filter(k => !columnasOcultas.includes(k) && k !== "FechaStr");

      let html = "<table><thead><tr>";
      encabezados.forEach(k => html += `<th>${k}</th>`);
      html += "</tr></thead><tbody>";

      data.forEach(row => {
        html += "<tr>";
        encabezados.forEach(k => {
          let val = row[k];
          if (k === "Fecha") val = convertirFecha(val);
          if (k === "KgsD") val = Number(val).toLocaleString("es-AR");
          html += `<td>${val}</td>`;
        });
        html += "</tr>";
      });

      html += "</tbody></table>";
      tablaDiv.innerHTML = html;
    }

    function descargarExcel() {
      const columnasOcultas = ["pagado", "ProveedorT"];
      const datosExportar = entregasFiltradas.map(row => {
        const fila = {};
        for (let key in row) {
          if (!columnasOcultas.includes(key) && key !== "FechaStr") {
            let val = row[key];
            if (key === "Fecha") val = convertirFecha(val);
            fila[key] = val;
          }
        }
        return fila;
      });

      const worksheet = XLSX.utils.json_to_sheet(datosExportar);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Entregas");
      XLSX.writeFile(workbook, "entregas.xlsx");
    }
  
    function mostrarResumenTotales(data) {
      const totalPera = data.filter(e => (e.Especie || "").toLowerCase() === "pera").reduce((sum, e) => sum + Number(e.KgsD || 0), 0);
      const totalManza = data.filter(e => (e.Especie || "").toLowerCase() === "manza").reduce((sum, e) => sum + Number(e.KgsD || 0), 0);
      const total = data.reduce((sum, e) => sum + Number(e.KgsD || 0), 0);
      document.getElementById("btnPera").innerText = `üçê Pera - ${totalPera.toLocaleString("es-AR")} kg`;
      document.getElementById("btnManzana").innerText = `üçé Manzana - ${totalManza.toLocaleString("es-AR")} kg`;
      document.getElementById("btnTodas").innerText = `üìã Todas - ${total.toLocaleString("es-AR")} kg`;
    }

    function mostrarMiniDetalle(tipo) {
      const cont = document.getElementById("miniDetalle");
      let datos = entregasOriginal;
      if (tipo === "pera") {
        datos = datos.filter(e => (e.Especie || "").toLowerCase() === "pera");
      } else if (tipo === "manza") {
        datos = datos.filter(e => (e.Especie || "").toLowerCase() === "manza");
      }

      const mini = datos.map(e => {
        const nro = e.nro || "-";
        const fec = convertirFecha(e.Fecha);
        const kgs = Number(e.KgsD || 0).toLocaleString("es-AR");
        return `<tr><td>${nro}</td><td>${fec}</td><td style="text-align:right;">${kgs}</td></tr>`;
      });

      cont.innerHTML = `
        <table style="margin:10px auto; font-size: 14px;">
          <thead><tr><th>Nro</th><th>Fecha</th><th>Kgs</th></tr></thead>
          <tbody>${mini.join("")}</tbody>
        </table>
        <button onclick="volverResumen()" style="margin-top: 5px; padding: 10px 15px;">üîô Volver</button>
      `;
      cont.style.display = "block";
      document.getElementById("resumenEspecies").style.display = "none";
    }

    function volverResumen() {
      document.getElementById("miniDetalle").style.display = "none";
      document.getElementById("resumenEspecies").style.display = "block";
    }

</script>
 </body>
</html>
