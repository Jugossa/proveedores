<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Portal Proveedores</title>
  <style>
    body { font-family: sans-serif; margin: 40px 20px; }
    input, button, select { padding: 10px; margin: 5px 5px 5px 0; }
    button { cursor: pointer; }
    #error { color: red; margin-top: 10px; }
    #bienvenida { margin: 20px 0 5px 0; font-size: 16px; color: green; font-weight: bold; display: none; }
    #aviso { font-size: 12px; color: black; margin-bottom: 15px; display: none; font-weight: normal; }
    #acciones { margin-top: 14px; display: flex; gap: 12px; flex-wrap: wrap; }
    #btnComprobantes { display: none; }
  </style>
</head>
<body>

  <div id="titulo" style="text-align: center; margin-bottom: 10px;">
    <img src="img/logo.png" alt="Logo Jugos SA" style="height: 60px;" />
    <h2 style="margin: 10px 0;">üîê Ingreso de Proveedores</h2>
  </div>

  <!-- Login -->
  <div id="login" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <input type="text" id="cui" placeholder="CUIT / CUIL" style="width: 180px;" />
    <input type="password" id="password" placeholder="Contrase√±a" style="width: 160px;" />
    <button onclick="login()">Ingresar</button>
  </div>
  <div id="avisoCuit" style="font-size: 12px; color: #444; margin: 4px 0 5px 0;">
    * El CUIT puede ingresarse con o sin guiones.
  </div>

  <div id="error"></div>
  <div id="bienvenida"></div>
  <div id="aviso">Cualquier consulta comunicarse con la administraci√≥n de Jugos SA.</div>

  <!-- Solo el bot√≥n pedido -->
  <div id="acciones">
    <button id="btnComprobantes" onclick="abrirComprobantes()">üìÑ Ver Comprobantes</button>
  </div>

  <script>
    // Guardamos el link del proveedor autenticado
    let URL_COMPROBANTES = "";

    // Normaliza CUI/CUIT a solo d√≠gitos para comparar
    function normalizarDocumento(s) {
      return String(s || "").replace(/\D+/g, "");
    }

    // Muestra el bot√≥n si el proveedor logueado tiene urlComprobantes en proveedores.json
    async function mostrarBotonComprobantes(cui, clave) {
      try {
        const res = await fetch('data/proveedores.json', { cache: 'no-cache' });
        const lista = await res.json();

        const cuiLogin   = normalizarDocumento(cui);
        const claveLogin = String(clave || "").trim();

        const prov = lista.find(p =>
          normalizarDocumento(p.cui) === cuiLogin &&
          String(p.clave || "").trim() === claveLogin
        );

        if (prov && prov.urlComprobantes) {
          URL_COMPROBANTES = String(prov.urlComprobantes).trim();
          document.getElementById('btnComprobantes').style.display = 'inline-block';
        } else {
          URL_COMPROBANTES = "";
          document.getElementById('btnComprobantes').style.display = 'none';
        }
      } catch (e) {
        console.error('Error cargando proveedores.json:', e);
      }
    }

    // Abre Drive en una pesta√±a nueva
    function abrirComprobantes() {
      if (URL_COMPROBANTES) {
        window.open(URL_COMPROBANTES, '_blank', 'noopener');
      }
    }

    // Login m√≠nimo: llama a tu endpoint existente y, si es OK, muestra el bot√≥n
    async function login() {
      const cui = document.getElementById("cui").value.trim();
      const password = document.getElementById("password").value.trim();
      const errorDiv = document.getElementById("error");
      const bienvenidaDiv = document.getElementById("bienvenida");
      const avisoDiv = document.getElementById("aviso");

      errorDiv.textContent = "";
      bienvenidaDiv.style.display = "none";
      avisoDiv.style.display = "none";
      document.getElementById('btnComprobantes').style.display = 'none';

      if (!cui || !password) {
        errorDiv.textContent = "Por favor complete CUIT y contrase√±a.";
        return;
      }

      try {
        const res = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cui, password })
        });

        if (res.status === 401) {
          errorDiv.textContent = "‚ùå CUIT o contrase√±a incorrectos.";
          return;
        }

        const result = await res.json();
        const nombre = result.proveedor || "Proveedor";

        // UI b√°sica de √©xito
        document.getElementById("login").style.display = "none";
        document.getElementById("avisoCuit").style.display = "none";
        bienvenidaDiv.innerHTML = `‚úÖ Bienvenido <strong>${nombre}</strong><br><span style="font-size: 13px; color: gray;">√öltima actualizaci√≥n: ${result.ultimaActualizacion || ''}</span>`;
        bienvenidaDiv.style.display = "block";
        avisoDiv.style.display = "block";

        // üî¥ Mostrar SOLO el bot√≥n pedido, en base al link de la √∫ltima columna (urlComprobantes)
        await mostrarBotonComprobantes(cui, password);

      } catch (err) {
        errorDiv.textContent = "‚ùå Error de red.";
        console.error(err);
      }
    }
  </script>
</body>
</html>
