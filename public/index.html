<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Portal Proveedores</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 40px 20px; max-width: none; }
    input, button, select { padding: 10px; margin: 5px 5px 5px 0; }
    input[type="date"] { width: auto; }
    button { cursor: pointer; }
    table { width: auto; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 14px; white-space: nowrap; }
    th { background: #f0f0f0; }
    #error { color: red; margin-top: 10px; }
    #resumen { font-weight: bold; margin: 10px 0; }

    /* === Cambio 1: alineaci√≥n estados + mantengo tu layout === */
    #acciones { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    #acciones button { width: auto; max-width: 200px; padding: 8px 12px; }
    .pauta-status{
      margin-left: auto;            /* empuja los estados a la derecha */
      display: flex;
      gap: 24px;
      color: #2e7d32;
      font-size: 12px;
      align-items: center;
    }

    #bienvenida { margin: 20px 0 5px 0; font-size: 16px; color: green; font-weight: bold; display: none; }
    #aviso { font-size: 12px; color: black; margin-bottom: 15px; display: none; font-weight: normal; }
    #filtroEspecie { width: auto; }
    td[col-id="KgsD"],td[col-id="CantBins"] { text-align: right; }
    #filtroFechas { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
    #filtroFechas label { margin-right: 5px; }
  </style>

  <!-- üëá BLOQUE NUEVO PARA BOTONES MINI Y MODAL DE PAUTA -->
  <style id="pauta-css">
    .btn-mini {
      font-size:12px; line-height:1;
      padding:6px 10px;
      border:1px solid #ccc;
      background:#f7f7f7;
      border-radius:4px;
      cursor:pointer;
    }
    .btn-mini:disabled { color:#777; background:#eee; cursor:not-allowed; }
    .input-mini { font-size:12px; padding:6px 8px; border:1px solid #ccc; border-radius:4px; min-width:160px; }
    #modalPauta { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); align-items:center; justify-content:center; z-index:9999; }
    #modalPauta .box { background:#fff; width:95%; max-width:900px; max-height:90%; overflow:auto; padding:12px; border-radius:8px; }
  </style>
</head>

<body>

  <div id="titulo" style="text-align: center; margin-bottom: 10px;">
    <img src="img/logo.png" alt="Logo Jugos SA" style="height: 60px;" />
    <h2 style="margin: 10px 0;">üîê Ingreso de Proveedores</h2>
  </div>

  <div id="login" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <input type="text" id="cui" placeholder="CUIT / CUIL" style="width: 150px;" />
    <input type="password" id="password" placeholder="Contrase√±a" style="width: 150px;" />
    <button onclick="login()">Ingresar</button>
  </div>

  <div id="avisoCuit" style="font-size: 12px; color: #444; margin: 4px 0 5px 0;">
    * El CUIT puede ingresarse con o sin guiones.
  </div>

  <div id="error"></div>
  <div id="bienvenida"></div>
  <div id="aviso">Cualquier consulta comunicarse con la administraci√≥n de Jugos SA.</div>

  <div id="filtros" style="display:none;">
    <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
      <label for="filtroEspecie">Especie:</label>
      <select id="filtroEspecie"></select>
      <label for="desde">Desde:</label>
      <input type="date" id="desde">
      <label for="hasta">Hasta:</label>
      <input type="date" id="hasta">
      <button onclick="filtrarEspecie()">Ver</button>
    </div>

    <div id="resumen"></div>
    <div id="acciones">
      <!-- ids agregados para poder ocultarlos si no hay datos -->
      <button id="btnExcel" onclick="descargarExcel()">üìÑ Descargar Excel</button> 
      <button id="btnPDF" onclick="window.print()">üìÖ Descargar PDF</button>

      <!-- ‚úÖ Botones de Pauta -->
      <button id="btnPauta" class="btn-mini">Firmar Pauta</button>
      <button id="btnPautaOrg" class="btn-mini" style="display:none;">Firmar Pauta Org√°nica</button>

      <!-- === Cambio 1: contenedor de estados a la derecha === -->
      <div class="pauta-status">
        <span id="pauta-estado"></span>
        <span id="pautaorg-estado"></span>
      </div>
    </div>
  </div>

  <div id="tabla"></div>

  <script>
    let entregasOriginal = [];
    let entregasFiltradas = [];

    function convertirFecha(excelNumber) {
      const baseDate = new Date(1899, 11, 30);
      const dias = parseInt(excelNumber);
      if (isNaN(dias)) return excelNumber;
      const fecha = new Date(baseDate.getTime() + dias * 86400000);
      return fecha.toLocaleDateString("es-AR", { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function fechaDentroDeRango(fechaStr, desdeStr, hastaStr) {
      if (!desdeStr && !hastaStr) return true;
      const [dia, mes, anio] = fechaStr.split("/");
      const fecha = new Date(`${anio}-${mes}-${dia}`);
      const desde = desdeStr ? new Date(desdeStr) : null;
      const hasta = hastaStr ? new Date(hastaStr) : null;
      if (desde && fecha < desde) return false;
      if (hasta && fecha > hasta) return false;
      return true;
    }

    async function login() {
      const cui = document.getElementById("cui").value.trim();
      const password = document.getElementById("password").value.trim();
      const errorDiv = document.getElementById("error");
      const tablaDiv = document.getElementById("tabla");
      const filtrosDiv = document.getElementById("filtros");
      const bienvenidaDiv = document.getElementById("bienvenida");
      const avisoDiv = document.getElementById("aviso");

      errorDiv.textContent = "";
      tablaDiv.innerHTML = "";
      filtrosDiv.style.display = "none";
      bienvenidaDiv.style.display = "none";
      avisoDiv.style.display = "none";

      if (!cui || !password) {
        errorDiv.textContent = "Por favor complete CUIT y contrase√±a.";
        return;
      }

      try {
        const res = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cui, password })
        });

        if (res.status === 401) {
          errorDiv.textContent = "‚ùå CUIT o contrase√±a incorrectos.";
          return;
        }

        const result = await res.json();
        const data = result.entregas || [];

        // Datos para Pauta / Pauta Org√°nica
        window.USER = {
          proveedor: result.proveedor || "",
          cuit: (cui || "").replace(/[^0-9]/g, ""),
          org: result.org || ""
        };
        renderPautaButtons(window.USER);

        // Mostrar encabezado y contenedor SIEMPRE (haya o no datos)
        document.getElementById("login").style.display = "none";
        const nombre = result.proveedor || "Proveedor";
        bienvenidaDiv.innerHTML = `‚úÖ Bienvenido <strong>${nombre}</strong><br><span style="font-size: 13px; color: gray;">√öltima actualizaci√≥n: ${result.ultimaActualizacion}</span>`;
        bienvenidaDiv.style.display = "block";
        avisoDiv.style.display = "block";
        document.getElementById("avisoCuit").style.display = "none";

        // === Cambio 2: permitir firmar aunque no haya entregas ===
        if (!data.length) {
          tablaDiv.innerHTML = "<p>No hay entregas registradas.</p>";

          // mostramos el contenedor para ver #acciones (botones de pauta)
          filtrosDiv.style.display = "block";

          // ocultamos la fila de filtros (primera fila)
          const filaFiltros = filtrosDiv.firstElementChild;
          if (filaFiltros) filaFiltros.style.display = "none";

          // ocultamos exportaciones (no hay datos)
          const bExcel = document.getElementById('btnExcel');
          const bPDF   = document.getElementById('btnPDF');
          if (bExcel) bExcel.style.display = 'none';
          if (bPDF)   bPDF.style.display   = 'none';

          return; // dejamos visibles los botones de pauta
        }

        // Caso con entregas (igual que antes)
        entregasOriginal = data.map(e => ({ ...e, Especie: (e.Especie || '').toUpperCase(), FechaStr: convertirFecha(e.Fecha) }));
        mostrarFiltrosYTabla(entregasOriginal);
      } catch (err) {
        errorDiv.textContent = "‚ùå Error de red.";
        console.error(err);
      }
    }

    function mostrarFiltrosYTabla(data) {
      const especies = [...new Set(data.map(e => e.Especie).filter(Boolean))];
      const select = document.getElementById("filtroEspecie");

      select.innerHTML = `<option value="TODAS">Todas las especies</option>`;
      especies.forEach(v => { select.innerHTML += `<option value="${v}">${v}</option>`; });

      document.getElementById("filtros").style.display = "block";
      filtrarEspecie();
    }

    function filtrarEspecie() {
      const especie = document.getElementById("filtroEspecie").value;
      const desde = document.getElementById("desde").value;
      const hasta = document.getElementById("hasta").value;

      entregasFiltradas = entregasOriginal.filter(e => {
        const coincideEspecie = especie === "TODAS" || e.Especie === especie;
        const enRango = fechaDentroDeRango(e.FechaStr, desde, hasta);
        return coincideEspecie && enRango;
      });

      renderTabla(entregasFiltradas);
    }

    function renderTabla(data) {
      const tablaDiv = document.getElementById("tabla");
      const resumenDiv = document.getElementById("resumen");

      if (!data.length) {
        tablaDiv.innerHTML = "<p>No hay datos.</p>";
        resumenDiv.textContent = "";
        return;
      }

      const totalKgs = data.reduce((sum, row) => sum + Number(row.KgsD || 0), 0);
      resumenDiv.textContent = `Total kilos entregados: ${totalKgs.toLocaleString("es-AR")} kg`;

      const columnasOcultas = ["pagado", "ProveedorT"];
      const encabezados = Object.keys(data[0]).filter(k => !columnasOcultas.includes(k) && k !== "FechaStr");

      let html = "<table><thead><tr>";
      encabezados.forEach(k => html += `<th col-id="${k}">${k}</th>`);
      html += "</tr></thead><tbody>";

      data.forEach(row => {
        html += "<tr>";
        encabezados.forEach(k => {
          let val = row[k];
          if (k === "Fecha") val = convertirFecha(val);
          if (k === "KgsD") val = Number(val).toLocaleString("es-AR");
          html += `<td col-id="${k}">${val}</td>`;
        });
        html += "</tr>";
      });

      html += "</tbody></table>";
      tablaDiv.innerHTML = html;
    }

    function descargarExcel() {
      const columnasOcultas = ["pagado", "ProveedorT"];
      const datosExportar = entregasFiltradas.map(row => {
        const fila = {};
        for (let key in row) {
          if (!columnasOcultas.includes(key) && key !== "FechaStr") {
            let val = row[key];
            if (key === "Fecha") val = convertirFecha(val);
            fila[key] = val;
          }
        }
        return fila;
      });

      const worksheet = XLSX.utils.json_to_sheet(datosExportar);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Entregas");
      XLSX.writeFile(workbook, "entregas.xlsx");
    }
  </script>
    
  <!-- üëá Bloque del modal de Pauta -->
  <div id="modalPauta">
    <div class="box">
      <h3 id="modalTitulo" style="margin:0 0 8px 0;font-size:16px;">Firmar Pauta</h3>
      <iframe id="pdfFrame" src="" style="width:100%; height:55vh; border:1px solid #ddd;"></iframe>

      <div style="margin-top:10px;">
        <label><input type="checkbox" id="chkAcepto"> Acepto los t√©rminos de la pauta</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;">
          <input id="inpResponsable" class="input-mini" placeholder="Responsable">
          <input id="inpCargo" class="input-mini" placeholder="Cargo">
          <input id="inpFecha" class="input-mini" placeholder="Fecha y hora" readonly>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <button id="btnConfirmar" class="btn-mini" disabled>Confirmar firma</button>
          <button id="btnCancelar" class="btn-mini">Cancelar</button>
          <a id="btnDescargar" class="btn-mini" download>Descargar PDF</a>
        </div>
      </div>
    </div>
  </div>
  <!-- üëÜ Fin del modal -->

  <script id="pauta-js">
  (function(){
    // ===== Config / helpers =====
    const qsTest = new URLSearchParams(location.search).get('test') === '1'; // modo prueba (?test=1)

    function getCuit(){
      if (window.USER?.cuit) return window.USER.cuit;
      const el = document.getElementById('cui') || document.querySelector('input[name="cui"]');
      return el && el.value ? el.value.replace(/[^0-9]/g,'') : '';
    }
    function getProveedor(){
      if (window.USER?.proveedor) return window.USER.proveedor;
      const strong = document.querySelector('#bienvenida strong') || document.getElementById('bienvenido-nombre');
      if (strong) return strong.textContent.trim();
      const txt = document.getElementById('bienvenida')?.textContent || '';
      const m = txt.match(/Bienvenido\s+(.+?)(?:\s+√öltima|$)/i);
      return m ? m[1].trim() : '';
    }
    function showOrgIfNeeded(){
      const bOrg = document.getElementById('btnPautaOrg');
      const orgFlag = (window.USER?.org === 'x' || window.USER?.org === 'X');
      if (bOrg) bOrg.style.display = orgFlag ? '' : 'none';
    }

    // ===== Pintar estado de botones (si ya firm√≥) =====
    function pintarEstado(s){
      const bP = document.getElementById('btnPauta');
      const bO = document.getElementById('btnPautaOrg');
      const eP = document.getElementById('pauta-estado');
      const eO = document.getElementById('pautaorg-estado');
      if (s?.pauta?.firmado){ bP.textContent='Pauta firmada'; bP.disabled=true; eP.textContent='Pauta firmada el '+s.pauta.fechaLocal; }
      if (s?.pautaorganica?.firmado){ bO.textContent='Pauta Org√°nica firmada'; bO.disabled=true; eO.textContent='Pauta Org√°nica firmada el '+s.pautaorganica.fechaLocal; }
    }

    // ===== Consultar estado al cargar =====
    function cargarEstado(){
      const cuit = getCuit();
      if (!cuit) { showOrgIfNeeded(); return; }
      fetch('/api/pauta/estado?cuit=' + encodeURIComponent(cuit))
        .then(r => r.ok ? r.json() : null)
        .then(s => { pintarEstado(s || {}); showOrgIfNeeded(); })
        .catch(() => showOrgIfNeeded());
    }

    // ===== Abrir modal y confirmar =====
    function abrir(tipo){
      const titulo = document.getElementById('modalTitulo');
      const frame  = document.getElementById('pdfFrame');
      const aDesc  = document.getElementById('btnDescargar');
      const chk    = document.getElementById('chkAcepto');
      const inpR   = document.getElementById('inpResponsable');
      const inpC   = document.getElementById('inpCargo');
      const inpF   = document.getElementById('inpFecha');
      const btnOK  = document.getElementById('btnConfirmar');
      const btnCancel = document.getElementById('btnCancelar');

      titulo.textContent = (tipo==='pauta'?'Firmar Pauta':'Firmar Pauta Org√°nica');
      const pdf = (tipo==='pauta') ? '/data/pauta/pauta.pdf' : '/data/pauta/pautaorganica.pdf';
      frame.src = pdf; aDesc.href = pdf;

      // reset
      chk.checked = false; inpR.value=''; inpC.value='';
      inpF.value = new Date().toLocaleString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}).replace(',', '');
      btnOK.disabled = true;

      // habilitar confirmar solo cuando todo est√© OK
      const validar = ()=> btnOK.disabled = !(chk.checked && inpR.value.trim() && inpC.value.trim());
      chk.onchange = validar; inpR.oninput = validar; inpC.oninput = validar;

      btnOK.onclick = async ()=>{
        btnOK.disabled = true;
        const body = {
          tipo,
          acepta: true,
          responsable: inpR.value.trim(),
          cargo: inpC.value.trim(),
          proveedor: getProveedor(),
          cuit: getCuit()
        };
        if (qsTest) body.test = 1; // modo prueba: guarda en pautaLog-test.json y NO toca Sheets

        try{
          const r = await fetch('/api/pauta/firmar', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
          const j = await r.json();
          if (j?.ok){
            if (tipo==='pauta'){
              const b = document.getElementById('btnPauta');
              b.textContent='Pauta firmada'; b.disabled=true;
              document.getElementById('pauta-estado').textContent = 'Pauta firmada el ' + j.fechaLocal;
            } else {
              const b = document.getElementById('btnPautaOrg');
              b.textContent='Pauta Org√°nica firmada'; b.disabled=true;
              document.getElementById('pautaorg-estado').textContent = 'Pauta Org√°nica firmada el ' + j.fechaLocal;
            }
          } else {
            alert('No se pudo registrar la firma' + (j?.error?': '+j.error:'')); 
          }
        } catch(e){
          alert('No se pudo conectar para registrar la firma.');
        } finally {
          document.getElementById('modalPauta').style.display = 'none';
        }
      };

      btnCancel.onclick = ()=>{ document.getElementById('modalPauta').style.display = 'none'; };
      document.getElementById('modalPauta').style.display = 'flex';
    }

    // ===== Wire-up de los botones =====
    const bP = document.getElementById('btnPauta');
    const bO = document.getElementById('btnPautaOrg');
    if (bP) bP.onclick = () => abrir('pauta');
    if (bO) bO.onclick = () => abrir('pautaorganica');

    // Ejecutar una vez (cuando ya suele estar el CUIT cargado). No rompe si no hay login a√∫n.
    setTimeout(cargarEstado, 300);

    // llamada desde login()
    window.renderPautaButtons = function(user){
      try { if (user) window.USER = user; } catch(_) {}
      showOrgIfNeeded();
    };
  })();
  </script>

  </body>
</html>
